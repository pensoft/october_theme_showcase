title = "Library"
url = "/library"
layout = "default"
is_hidden = 0
robot_index = "index"
robot_follow = "follow"

[LibraryPage]
templates = "template4"
no_records_message = "No records found"
==
<?php
use Pensoft\Library\Classes\ZipFiles;
use Pensoft\Library\Models\Library;

function onStart(){
	$options = post('Filter', []);

	extract(
            array_merge([
                'sort' => 'created_at desc',
                'type' => 0,
            ], $options)
    );
$library =Library::where('is_visible', true)->orderBy('year', 'desc');

if(post('Filter')){
    switch (post('Filter')['type']){
        case 1:
            $library =Library::isVisible()->ofType(5)->orderBy('title', 'asc');
        break;
        case 2:
            $library =Library::isVisible()->ofType(1)->where('derived', 2);
        break;
        case 3:
            $library =Library::isVisible()->ofType(1)->where('derived', 1);
        break;
    }

    if(in_array(post('Filter')['sort'], array_keys(Library::$allowSortingOptions))){
        $parts = explode(' ', $sort);
        list($sortField, $sortDirection) = $parts;
        $library->orderBy($sortField, $sortDirection);
    }
}


$this['data'] = $library->get();

$this['mySortOptions'] = [
'year desc' => 'Year (desc)',
'year asc' => 'Year (asc)',
];

$this['filterTypesOptions'] = [
1 => 'Deliverables',
2 => 'Relevant Publications',
3 => 'SHOWCASE Publications',
];
$this['total_file_size_bites'] = $this['data']->reduce(function ($carry, $item) {
                                                        if ($item->file) {
                                                            return $carry + $item->file->file_size;
                                                        }
                                                        return $carry;
                                                        }, 0);
$this['total_file_size'] = $this['total_file_size_bites'];

}

?>
==
<div class="container text-center">
    {%if total_file_size_bites%}
    <div class="row center-xs mb-1">
        <div class="col-xs">
            {{ form_open({request: 'onDownloadAll'}) }}
            <button type="submit" href="#" class="btn btn-primary"><i class="pr normal p-download"></i> Download all publications ({{ (total_file_size / 1024 / 1024 )|round(2)}} MB)</button>
            {{ form_close() }}
        </div>
    </div>
    {%endif%}

    {{ form_ajax('onStart', { update: {'components/libraries': '#partialLibraries'} }) }}

    <div id="libraryForm" class="ui form libraryForm">
        <div class="row">
            <div class="col-sm-3 col-xs">
                <div class="field">
                    <select name="Filter[type]">
                        <option selected>All types of documents</option>
                        {% for code,option in filterTypesOptions %}
                        <option value="{{code}}">{{option}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-sm-2 col-xs">
                <div class="field">
                    <select name="Filter[sort]">
                        {% for code,option in mySortOptions %}
                        <option value="{{code}}">{{option}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

    </div>
    {{ form_close() }}

    <div class='library-items' id="partialLibraries">
        {% for record in data %}
        <div class="library-item row center-xs start-sm">

            {% if record.preview %}
            <div class="col-xs-3">
                {% if record.preview.content_type == 'video/mp4' %}
                <video controls="" width="100%"><source src="{{record.preview.path}}" type="video/mp4"></video>
                {% else %}
                <img src="{{record.preview.getThumb(193,250, { mode : 'crop' } )}}" class="{{record.file.getExtension()}}_preview">
                {% endif %}
            </div>
            {% endif %}

            <div class="col-xs pl-1">
                <div class="news-title">
                    <h3 class="card-title">{{ record.title }}</h3>
                </div>
                <div class="body">
                    {% partial __SELF__ ~ "::libraries-content" label="Authors:" value=record.authors %}
                    {% if record.type == 5 %}
                        {% if record.status == 1 %}
                            {% set status = 'Approved' %}
                        {% else %}
                            {% set status = 'Subject to change' %}
                        {% endif %}
                    {% else %}
                        {% set status = record.status_attr %}
                    {% endif %}
                    {% partial __SELF__ ~ "::libraries-content" label="Status:" value=status %}
                    {% partial __SELF__ ~ "::libraries-content" label="Year:" value=record.year_attr %}

                    {% partial __SELF__ ~ "::libraries-content" label="Journal:" value=record.journal_title %}
                    {% partial __SELF__ ~ "::libraries-content" label="Proceedings:" value=record.proceedings_title %}
                    {% partial __SELF__ ~ "::libraries-content" label="Monograph:" value=record.monograph_title %}
                    {% partial __SELF__ ~ "::libraries-content" label="Deliverable number:" value=record.deliverable_title %}
                    {% partial __SELF__ ~ "::libraries-content" label="Project:" value=record.project_title %}

                    {% partial __SELF__ ~ "::libraries-content" label="Volume/Issue:" value=record.volume_issue %}
                    {% partial __SELF__ ~ "::libraries-content" label="Publisher:" value=record.publisher  %}
                    {% partial __SELF__ ~ "::libraries-content" label="Place:" value=record.place  %}
                    {% partial __SELF__ ~ "::libraries-content" label="City:" value=record.city  %}
                    {% partial __SELF__ ~ "::libraries-content" label="Pages:" value=record.pages  %}
                    {% partial __SELF__ ~ "::libraries-content" label="URL/DOI:" value=record.doi is_link=true  %}
                </div>
                {%if record.file %}
                <div class="col-xs-12 text-center">
                    <div class="row middle-xs">
                        <div class="col-xs-12">
                            <div class="d-flex flex-column justify-content-start flex-lg-row mt-1 d-flex align-items-start">
                                <a target="_blank" href="{{record.file.path()}}" class="btn btn-primary no-margin"><i class="pr normal p-download"></i>Download ({{(record.file.file_size / 1024 / 1024 )|round(2)}} MB)</a>
                            </div>
                        </div>
                    </div>
                </div>
                {%endif%}
            </div>
        </div>

        {% endfor %}
    </div>


</div>
